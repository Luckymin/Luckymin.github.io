<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu | Min blog | Thought is already is late, exactly is the earliest time.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Android第三方开源项目解析">
  <meta name="description" content="在上一篇我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么">
<meta property="og:type" content="article">
<meta property="og:title" content="第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu">
<meta property="og:url" content="http://yoursite.com/2016/03/09/2016030311_android_floating_action_button_part2/index.html">
<meta property="og:site_name" content="Min blog">
<meta property="og:description" content="在上一篇我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么">
<meta property="og:image" content="http://7xpaar.com1.z0.glb.clouddn.com/menu.gif">
<meta property="og:image" content="http://7xpaar.com1.z0.glb.clouddn.com/labels.png">
<meta property="og:updated_time" content="2016-03-09T04:58:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu">
<meta name="twitter:description" content="在上一篇我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么">
  
    <link rel="alternative" href="/atom.xml" title="Min blog" type="application/atom+xml">
  
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="loading" class="active"></div>

  <nav id="menu" class="hide" >
   <div class="inner">
  <a href="javascript:;" class="header-icon waves-circle-light" id="menu-off">
      <i class="icon icon-lg icon-close"></i>
  </a>
  <div class="brand-wrap">
    <div class="brand">
      <a href="./" class="avatar"><img src="/img/logo.jpeg"></a>
      <hgroup class="introduce">
        <h5 class="nickname">花生牛奶巧克力</h5>
        <a href="mailto:undefined" title="kluckymin@gmail.com" class="mail">kluckymin@gmail.com</a>
      </hgroup>
    </div>
  </div>
  <ul class="nav">
    
        <li class="waves-block">
          <a href="/"  >
            <i class="icon icon-lg icon-home"></i>Home
          </a>
        </li>
    
        <li class="waves-block">
          <a href="/archives"  >
            <i class="icon icon-lg icon-archives"></i>Archives
          </a>
        </li>
    
        <li class="waves-block">
          <a href="/tags"  >
            <i class="icon icon-lg icon-tags"></i>Tags
          </a>
        </li>
    
        <li class="waves-block">
          <a href="https://github.com/Luckymin" target="_blank" >
            <i class="icon icon-lg icon-github"></i>Github
          </a>
        </li>
    
        <li class="waves-block">
          <a href="http://weibo.com/staringmake" target="_blank" >
            <i class="icon icon-lg icon-weibo"></i>Weibo
          </a>
        </li>
    
  </ul>

  <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>Min blog &copy; 2017</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

</div>

  </nav>
  <main id="main">
    <header class="header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-circle-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu</div>
        <a href="javascript:;" class="header-icon waves-circle-light" id="menu-share">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
    </div>
</header>
<header class="content-header">
  <div class="container">
    <h1 class="author">第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu</h1>
    <h5 class="subtitle">2016-03-09</h5>
  </div>
</header>

    <div class="container body-wrap">
      
  <article id="post-2016030311_android_floating_action_button_part2" class="article article-type-post" itemscope itemprop="blogPost">
    
      <div class="post-meat flex-row">
        <div class="flex-col">
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android第三方开源项目解析/">Android第三方开源项目解析</a></li></ul>
</div>
      </div>
      <div class="post-body">

        <aside class="post-widget" id="post-widget">

          
          <div class="post-share" id="post-share" data-title="第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu" data-pic="/img/logo.jpeg" data-summary="&lt;p&gt;在&lt;a href=&quot;http://luckymin.com/2016/03/03/2016030311_android_floating_action_button_part1/&quot;&gt;上一篇&lt;/a&gt;我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么使用吧。&lt;/p&gt;" data-url="http://yoursite.com/2016/03/09/2016030311_android_floating_action_button_part2/index.html">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>

          

          
          <nav class="post-toc-wrap" id="post-toc">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#FloatingActionMenu__u7684_u4F7F_u7528"><span class="post-toc-text">FloatingActionMenu 的使用</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#FloatingActionMenu__u89E3_u6790"><span class="post-toc-text">FloatingActionMenu 解析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#u4E00_u3001init_28_29"><span class="post-toc-text">一、init()</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#u4E8C_u3001onFinishInflate_28_29"><span class="post-toc-text">二、onFinishInflate()</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#u4E09_u3001onMeasure_28_29"><span class="post-toc-text">三、onMeasure()</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#onLayout_28_29"><span class="post-toc-text">onLayout()</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#toggle__u5C55_u5F00/_u6298_u53E0_u7684_u5F00_u5173"><span class="post-toc-text">toggle 展开/折叠的开关</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#u6700_u540E"><span class="post-toc-text">最后</span></a></li></ol>
          </nav>
          
        </aside>

        <div class="post-main">

            <div class="post-content" itemprop="postContent"><p>在<a href="http://luckymin.com/2016/03/03/2016030311_android_floating_action_button_part1/" target="_blank" rel="external">上一篇</a>我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么使用吧。</p>
<a id="more"></a> 
<h1 id="FloatingActionMenu__u7684_u4F7F_u7528"><a href="#FloatingActionMenu__u7684_u4F7F_u7528" class="headerlink" title="FloatingActionMenu 的使用"></a>FloatingActionMenu 的使用</h1><p>FloatingActionMenu 继承自 ViewGroup ，xml中的写法如下</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionsMenu</span></span><br><span class="line">     android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">     android:layout_height=<span class="string">"wrap_content"</span>&gt;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">     &lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionButton</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span>/&gt;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionButton</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span>/&gt;</span><br><span class="line">        </span><br><span class="line">&lt;/com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionsMenu</span>&gt;</span><br></pre></td></tr></table></figure>
<p>只要简单的包裹 FloatingActionButton 就可以达到下面的效果</p>
<p><img src="http://7xpaar.com1.z0.glb.clouddn.com/menu.gif" alt=""></p>
<p>如果想要在展开的按钮旁边显示文字标签的话，只需要为 FloatingActionMenu 设置 fab_labelStyle 属性，然后给子控件 FloatingActionButton 设置 fab_title 属性就行了，从属性名就可以看出来 fab_labelStyle 设置的是标签的的文本样式，fab_title 属性设置的是标签的文本内容，xml的写法如下:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionsMenu</span></span><br><span class="line">    android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">    android:layout_centerInParent=<span class="string">"true"</span></span><br><span class="line">    app:fab_labelStyle=<span class="string">"@style/menu_labels_style"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionButton</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        app:fabSize=<span class="string">"mini"</span></span><br><span class="line">        app:fab_title=<span class="string">"Text Document"</span>/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionButton</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        app:fabSize=<span class="string">"mini"</span></span><br><span class="line">        app:fab_title=<span class="string">"Spreadsheet"</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionButton</span></span><br><span class="line">        android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">        android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">        app:fabSize=<span class="string">"mini"</span></span><br><span class="line">        app:fab_title=<span class="string">"Presentation"</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/com<span class="class">.getbase</span><span class="class">.floatingactionbutton</span><span class="class">.FloatingActionsMenu</span>&gt;</span><br></pre></td></tr></table></figure>
<p>显示的效果如下：</p>
<p><img src="http://7xpaar.com1.z0.glb.clouddn.com/labels.png" alt=""></p>
<blockquote>
<p>如果想要显示标签文字，那么必须设置 fab_labelStyle 属性，否则标签文字不会显示</p>
</blockquote>
<p>FloatingActionButton 大概的用法就是这样，根据上面一些ui效果表现和xml布局用法，我们就可以得到如下信息：</p>
<ol>
<li>上图中的 ‘+’ 号按钮是在 FloatinActionMenu 的代码中完成添加的，展开的悬浮按钮为 FloatinActionMenu 的子控件</li>
<li>当点击按钮时开始动画操作，从上图中能看到 3 个动画，第一个是 ‘+’ 号按钮的旋转动画，另外就是展开/折叠时的平移动画和透明渐变动画</li>
</ol>
<p>当然只是上面这点东西还远远不能让我们知道 FloatingActionMenu 是怎么实现的，接下来就让我们开始分析 FloatingActionMenu 的代码吧。</p>
<h1 id="FloatingActionMenu__u89E3_u6790"><a href="#FloatingActionMenu__u89E3_u6790" class="headerlink" title="FloatingActionMenu 解析"></a>FloatingActionMenu 解析</h1><p>首先我先说下 FloatingActionMenu 调用的大致流程，如下：</p>
<ol>
<li>初始化时调用 init() 方法获取如 fab_labelStyle 等属性，然后调用 createAddButton() 方法添加 ‘+’ 号按钮。</li>
<li>重写 onFinishInflate() 方法，调用 createLabels() 方法创建标签文字。</li>
<li>重写 onMeasure() 方法，设置控件的大小。</li>
<li>重写 onLayout() 方法，对子控件进行布局。</li>
<li>当点击 ‘+’ 号按钮的时候菜单展开/折叠。</li>
</ol>
<p>接下来就让我们按照上面的顺序对 FloatingActionMenu 进行分析。</p>
<h2 id="u4E00_u3001init_28_29"><a href="#u4E00_u3001init_28_29" class="headerlink" title="一、init()"></a>一、init()</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attributeSet)</span> </span>&#123;</span><br><span class="line">    mButtonSpacing = (<span class="keyword">int</span>) (getResources().getDimension(R.dimen.fab_actions_spacing) - getResources().getDimension(R.dimen.fab_shadow_radius) - getResources().getDimension(R.dimen.fab_shadow_offset));</span><br><span class="line">    mLabelsMargin = getResources().getDimensionPixelSize(R.dimen.fab_labels_margin);</span><br><span class="line">    mLabelsVerticalOffset = getResources().getDimensionPixelSize(R.dimen.fab_shadow_offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于控制标签文字的触摸动作</span></span><br><span class="line">    mTouchDelegateGroup = <span class="keyword">new</span> TouchDelegateGroup(<span class="keyword">this</span>);</span><br><span class="line">    setTouchDelegate(mTouchDelegateGroup);</span><br><span class="line"></span><br><span class="line">    TypedArray attr = context.obtainStyledAttributes(attributeSet, R.styleable.FloatingActionsMenu, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//'+'号的颜色</span></span><br><span class="line">    mAddButtonPlusColor = attr.getColor(R.styleable.FloatingActionsMenu_fab_addButtonPlusIconColor, getColor(android.R.color.white));</span><br><span class="line">    <span class="comment">//'+'号按钮正常状态下颜色</span></span><br><span class="line">    mAddButtonColorNormal = attr.getColor(R.styleable.FloatingActionsMenu_fab_addButtonColorNormal, getColor(android.R.color.holo_blue_dark));</span><br><span class="line">    <span class="comment">//'+'号按钮按下颜色</span></span><br><span class="line">    mAddButtonColorPressed = attr.getColor(R.styleable.FloatingActionsMenu_fab_addButtonColorPressed, getColor(android.R.color.holo_blue_light));</span><br><span class="line">    <span class="comment">//'+'号的大小，同FloatingActionButton里面的size</span></span><br><span class="line">    mAddButtonSize = attr.getInt(R.styleable.FloatingActionsMenu_fab_addButtonSize, FloatingActionButton.SIZE_NORMAL);</span><br><span class="line">    <span class="comment">//'+'号边框是否可见，同FloatingActionButton里面的StrokeVisible</span></span><br><span class="line">    mAddButtonStrokeVisible = attr.getBoolean(R.styleable.FloatingActionsMenu_fab_addButtonStrokeVisible, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//菜单展开方向</span></span><br><span class="line">    <span class="comment">//up '+'号按钮在下菜单向上弹出，bottom与其相反。</span></span><br><span class="line">    <span class="comment">//right '+'号按钮在左菜单向右弹出 left与其相反</span></span><br><span class="line">    mExpandDirection = attr.getInt(R.styleable.FloatingActionsMenu_fab_expandDirection, EXPAND_UP);</span><br><span class="line">    <span class="comment">//标签文字的文本样式，如果为0则不会显示label文字</span></span><br><span class="line">    mLabelsStyle = attr.getResourceId(R.styleable.FloatingActionsMenu_fab_labelStyle, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//标签文字的位置，只能是 left or right</span></span><br><span class="line">    mLabelsPosition = attr.getInt(R.styleable.FloatingActionsMenu_fab_labelsPosition, LABELS_ON_LEFT_SIDE);</span><br><span class="line">    attr.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mLabelsStyle != <span class="number">0</span> &amp;&amp; expandsHorizontally()) &#123;</span><br><span class="line">        <span class="comment">//当mExpandDirection = left or mExpandDirection = right 不能设置标签文字的文本样式</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Action labels in horizontal expand orientation is not supported."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 '+' 号按钮</span></span><br><span class="line">    createAddButton(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>init() 里的代码都很好理解，第 7~8 行的mTouchDelegateGroup 是用于处理标签文字的触摸事件，基本上调用者只会对悬浮按钮也就是 FloatingActionButton 设置点击监听，这时候如果点击标签文字那么将会没有任何反应，如果在为标签文字设置一次点击监听，感觉又是多余的操作，mTouchDelegateGroup 就是为了解决这个问题，mTouchDelegateGroup 继承自 TouchDelegate 可以将标签文字的触摸事件传递给 FloatingActionButton 让其进行处理，最后的 createAddButton() 按钮，这个按钮就是点击后菜单就会展开/折叠的 ‘+’ 号按钮，具体代码如下:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">createAddButton</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mAddButton = <span class="keyword">new</span> AddFloatingActionButton(context) &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">updateBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            mPlusColor = mAddButtonPlusColor;</span><br><span class="line">            mColorNormal = mAddButtonColorNormal;</span><br><span class="line">            mColorPressed = mAddButtonColorPressed;</span><br><span class="line">            mStrokeVisible = mAddButtonStrokeVisible;</span><br><span class="line">            <span class="keyword">super</span>.updateBackground();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function">Drawable <span class="title">getIconDrawable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> RotatingDrawable rotatingDrawable = <span class="keyword">new</span> RotatingDrawable(<span class="keyword">super</span>.getIconDrawable());</span><br><span class="line">            mRotatingDrawable = rotatingDrawable;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//菜单折叠动画  角度 90 + 45 到 0</span></span><br><span class="line">            <span class="keyword">final</span> ObjectAnimator collapseAnimator = ObjectAnimator.ofFloat(rotatingDrawable, <span class="string">"rotation"</span>, EXPANDED_PLUS_ROTATION, COLLAPSED_PLUS_ROTATION);</span><br><span class="line">            <span class="comment">//菜单展开动画  角度 0 到 90 + 45</span></span><br><span class="line">            <span class="keyword">final</span> ObjectAnimator expandAnimator = ObjectAnimator.ofFloat(rotatingDrawable, <span class="string">"rotation"</span>, COLLAPSED_PLUS_ROTATION, EXPANDED_PLUS_ROTATION);</span><br><span class="line"></span><br><span class="line">			<span class="comment">//设置插值器 使动画的旋转角度会先大于设定的结束值，然后在回到结束值</span></span><br><span class="line">            <span class="keyword">final</span> OvershootInterpolator interpolator = <span class="keyword">new</span> OvershootInterpolator();</span><br><span class="line">            collapseAnimator.setInterpolator(interpolator);</span><br><span class="line">            expandAnimator.setInterpolator(interpolator);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//放入AnimatorSet</span></span><br><span class="line">            mExpandAnimation.play(expandAnimator);</span><br><span class="line">            mCollapseAnimation.play(collapseAnimator);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> rotatingDrawable;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    mAddButton.setId(R.id.fab_expand_menu_button);</span><br><span class="line">    mAddButton.setSize(mAddButtonSize);</span><br><span class="line">    mAddButton.setOnClickListener(<span class="keyword">new</span> OnClickListener() &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">            toggle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    addView(mAddButton, <span class="keyword">super</span>.generateDefaultLayoutParams());</span><br><span class="line">    mButtonsCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>createAddButton() 方法做的事情很简单就是创建一个 AddFloatingActionButton 然后调用 addView() 添加到控件里，第四行的 toggle() 就是会将菜单展开/折叠的方法，这个方面后面再说。我们先来看看 AddFloatingActionButton 是什么东西。</p>
<p>AddFloatingActionButton 继承自 FloatingActionButton，它重写了 getIconDrawable() 方法不再根据调用者给予的图片资源设置图标，而是使用 ShapeDrawable 画了一个 ‘+’ 图片，也就是上面图片中可以看到的悬浮按钮里的 ‘+’ 号，代码就不贴出来了。</p>
<p>在这里 mAddButton 实例化的时候再次重写了 getIconDrawable() 和 updateBackground() 方法，updateBackground() 很简单就不说了，主要是 getIconDrawable() ，这个方法主要做的事情就是，创建 2 个对 ‘+’ 号按钮进行旋转操作的属性动画，这 2 个动画分别对应展开时的旋转动画和折叠时的旋转动画，然后将这 2 个旋转动画放入对应的动画集合中，到这里我们应该还能猜到，后面应该还会有展开/折叠时相对应的平移动画和透明渐变动画会加入到这 2 个动画合集中。</p>
<p>另外 RotatingDrawable 是一个自定义类 继承自 LayerDrawable 这是一个用于配合上面的属性动画使用的 Drawable，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RotatingDrawable</span> <span class="keyword">extends</span> <span class="title">LayerDrawable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RotatingDrawable</span><span class="params">(Drawable drawable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> Drawable[]&#123;drawable&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mRotation;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"UnusedDeclaration"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getRotation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRotation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@SuppressWarnings</span>(<span class="string">"UnusedDeclaration"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRotation</span><span class="params">(<span class="keyword">float</span> rotation)</span> </span>&#123;</span><br><span class="line">        mRotation = rotation;</span><br><span class="line">        invalidateSelf();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        canvas.save();</span><br><span class="line">        canvas.rotate(mRotation, getBounds().centerX(), getBounds().centerY());</span><br><span class="line">        <span class="keyword">super</span>.draw(canvas);</span><br><span class="line">        canvas.restore();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里第一步的 init() 就解析完了，init() 主要做的事情就 3 样</p>
<ol>
<li>获取自定义的一些属性如 fab_labelStyle 、fab_expandDirection 等。</li>
<li>创建一个 AddFloatingActionButton 对象并重写 getIconDrawable 方法。并创建属性动画用于改变其角度让其旋转（此处的 AnimatorSet 拥有了第一个动画：旋转动画）</li>
<li>设置点击监听上图中的展开/折叠动画都是在这个监听里开始的</li>
<li>调用addView()将这个按钮添加到菜单中</li>
</ol>
<h2 id="u4E8C_u3001onFinishInflate_28_29"><a href="#u4E8C_u3001onFinishInflate_28_29" class="headerlink" title="二、onFinishInflate()"></a>二、onFinishInflate()</h2><p>onFinishInflate() 方法会在所有子控件从xml中 inflate 完后调用。也是 FloatingActionsMenu 这个类里面在 init() 之后被调用的方法，先来看下代码：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onFinishInflate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onFinishInflate();</span><br><span class="line">    <span class="comment">//改变位置 将mAddButton 放到最前面</span></span><br><span class="line">    bringChildToFront(mAddButton);</span><br><span class="line">    mButtonsCount = getChildCount();</span><br><span class="line">    <span class="keyword">if</span> (mLabelsStyle != <span class="number">0</span>) &#123;</span><br><span class="line">        createLabels();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，先是调用 bringChildToFront(mAddButton) 将上面刚刚添加到控件中的 ‘+’ 号按钮的顺序改变，在调用这个方法之前 mAddButton 顺序是在最前面这样绘制的时候 mAddButton 就会在其他的悬浮按钮下面，调用之后 mAddButton 的顺序就会在最后面，绘制的时候就会在其他悬浮按钮的上面了，<br>之后如果 mLabelsStyle 不等 0 的话就会调用 createLabels() 创建标签文字，可以看到如果想显示标签文字那么就必须设置 fab_labelStyle 属性，同时在各位应该还记得在 init() 中如果菜单的弹出方向是 left 或 or 的话那么就不能设置 fab_labelStyle 属性，否则将会报异常。</p>
<p>接下来让我们来看 createLabels() 里的代码：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">private</span> void createLabels() &#123;</span><br><span class="line">    Context context = new ContextThemeWrapper(getContext(), <span class="keyword">mLabelsStyle);</span><br><span class="line"></span>    </span><br><span class="line">    for (int i = <span class="number">0</span><span class="comment">; i &lt; mButtonsCount; i++) &#123;</span></span><br><span class="line">        FloatingActionButton <span class="keyword">button </span>= (FloatingActionButton) getChildAt(i)<span class="comment">;</span></span><br><span class="line">        <span class="keyword">String </span>title = <span class="keyword">button.getTitle();</span><br><span class="line"></span></span><br><span class="line">        //按钮为 <span class="string">'+'</span> 号按钮 or 文字为空 or 已经设置过了 就跳过</span><br><span class="line">        <span class="preprocessor">if</span> (<span class="keyword">button </span>== mAddButton <span class="title">||</span> title == null <span class="title">||</span></span><br><span class="line">                <span class="keyword">button.getTag(R.id.fab_label) </span>!= null) continue<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">        TextView label = new TextView(context)<span class="comment">;</span></span><br><span class="line">        label.setTextAppearance(getContext(), <span class="keyword">mLabelsStyle);</span><br><span class="line"></span>        label.setText(<span class="keyword">button.getTitle());</span><br><span class="line"></span>        <span class="keyword">addView(label);</span><br><span class="line"></span>        //用按钮的 tag 保存 TextView</span><br><span class="line">        <span class="keyword">button.setTag(R.id.fab_label, </span>label)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到标签文字的创建时根据子控件 FloatingActionButton 的 Title 来创建的而且最后标签文字的 TextView 控件也是使用 FloatingActionButton 的 setTag() 方法来保持引用的。</p>
<p>onFinishInflate() 的代码很简单，就做了 2 件事情：</p>
<ol>
<li>将 ‘+’ 号按钮的顺序放到其他悬浮按钮的后面，让其能够在绘制时出去其他悬浮按钮之上。</li>
<li>根据对应的 FloatingActionButton 的 Title 创建 TextView 然后加入到菜单中，最后使用 FloatingActionButton 的setTag 保持引用</li>
</ol>
<h2 id="u4E09_u3001onMeasure_28_29"><a href="#u4E09_u3001onMeasure_28_29" class="headerlink" title="三、onMeasure()"></a>三、onMeasure()</h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> onMeasure(<span class="built_in">int</span> widthMeasureSpec, <span class="built_in">int</span> heightMeasureSpec) &#123;</span><br><span class="line">    <span class="comment">//测量所有子视图的大小</span></span><br><span class="line">    measureChildren(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//控件的宽/高</span></span><br><span class="line">    <span class="built_in">int</span> <span class="variable">width</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> <span class="variable">height</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//悬浮按钮最大宽度/高度</span></span><br><span class="line">    mMaxButtonWidth = <span class="number">0</span>;</span><br><span class="line">    mMaxButtonHeight = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//标签文字最大长度</span></span><br><span class="line">    <span class="built_in">int</span> maxLabelWidth = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; mButtonsCount; i++) &#123;</span><br><span class="line">        View child = getChildAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (child.getVisibility() == GONE) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mExpandDirection) &#123;</span><br><span class="line">            <span class="keyword">case</span> EXPAND_UP:</span><br><span class="line">            <span class="keyword">case</span> EXPAND_DOWN:</span><br><span class="line">                <span class="comment">//拿到childView最大的宽度</span></span><br><span class="line">                mMaxButtonWidth = Math.<span class="built_in">max</span>(mMaxButtonWidth, child.getMeasuredWidth());</span><br><span class="line">                <span class="comment">//菜单方向为竖向时</span></span><br><span class="line">                <span class="comment">//将子控件的高度相加</span></span><br><span class="line">                <span class="variable">height</span> += child.getMeasuredHeight();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXPAND_LEFT:</span><br><span class="line">            <span class="keyword">case</span> EXPAND_RIGHT:</span><br><span class="line">                <span class="comment">//菜单方向为横向时</span></span><br><span class="line">                <span class="comment">//将子控件的加宽度</span></span><br><span class="line">                <span class="variable">width</span> += child.getMeasuredWidth();</span><br><span class="line">                <span class="comment">//拿到childView最大高度</span></span><br><span class="line">                mMaxButtonHeight = Math.<span class="built_in">max</span>(mMaxButtonHeight, child.getMeasuredHeight());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!expandsHorizontally()) &#123;</span><br><span class="line">            TextView label = (TextView) child.getTag(R.id.fab_label);</span><br><span class="line">            <span class="keyword">if</span> (label != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//拿到标签文字最大的宽度</span></span><br><span class="line">                maxLabelWidth = Math.<span class="built_in">max</span>(maxLabelWidth, label.getMeasuredWidth());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!expandsHorizontally()) &#123;</span><br><span class="line">        <span class="comment">//菜单弹出方向为竖向</span></span><br><span class="line">        <span class="comment">//控件的宽度需要加上标签文字和边距的宽度</span></span><br><span class="line">        <span class="variable">width</span> = mMaxButtonWidth + (maxLabelWidth &gt; <span class="number">0</span> ? maxLabelWidth + mLabelsMargin : <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">height</span> = mMaxButtonHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (mExpandDirection) &#123;</span><br><span class="line">        <span class="keyword">case</span> EXPAND_UP:</span><br><span class="line">        <span class="keyword">case</span> EXPAND_DOWN:</span><br><span class="line">            <span class="variable">height</span> += mButtonSpacing * (mButtonsCount - <span class="number">1</span>);</span><br><span class="line">            <span class="variable">height</span> = adjustForOvershoot(<span class="variable">height</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EXPAND_LEFT:</span><br><span class="line">        <span class="keyword">case</span> EXPAND_RIGHT:</span><br><span class="line">            <span class="variable">width</span> += mButtonSpacing * (mButtonsCount - <span class="number">1</span>);</span><br><span class="line">            <span class="variable">width</span> = adjustForOvershoot(<span class="variable">width</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setMeasuredDimension(<span class="variable">width</span>, <span class="variable">height</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onMeasure() 还是比较长的，首先第 3 行的 measureChildren 方法显示把所有的子控件的大小给测量出来，这里我只分析下菜单方向为竖向时的情况，横向时也是大同小异就不重复说明了。</p>
<p><strong>竖向 up or down</strong></p>
<ul>
<li>26~31 记录下悬浮按钮的最大宽度和所有悬浮按钮的总高度。</li>
<li>42~48 如果所对应的标签文字不为空的话那么会记录下最大的文字宽度。</li>
<li>54行 计算控件的宽度，宽度 = 悬浮按钮的最大宽度 + 标签文字的最大宽度 + 按钮和文字之间的间隔（如果标签文字为空，那么最终的宽度就是悬浮按钮的最大宽度）</li>
<li>62~64 计算控件的高度，高度 = (悬浮按钮的总高度 + 每个悬浮按钮之间的间隔之和) * 12 / 10。</li>
</ul>
<p>控件高度计算里的 12 / 10 是哪里来的呢？其实这个就是 adjustForOvershoot 方法里干的事情，先来看下代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">adjustForOvershoot</span><span class="params">(<span class="keyword">int</span> dimension)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dimension * <span class="number">12</span> / <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里为什么要乘以 12/10 呢？还记之前看到的 gif 中菜单展开时候的效果吗？菜单展开时有个回弹的效果，这个是因为后面的代码里为属性动画设置了插值器 OvershootInterpolator ，设置了这个插值器后，动画到达结束位置时会再向后运动一定的值，之后再回到原来的结束位置。因此我们在设置高度的时候就避免动画过程中我们的子控件超出了控件范围。</p>
<p>最后调用 setMeasuredDimension 设置控件的大小 onMeasure 方法就结束了。</p>
<p>最后总结为，当菜单方向为竖向时：</p>
<ul>
<li>标签文本不为空时 width = 悬浮按钮们的最大宽度 + 标签文字的最大宽度 + 2者的间距。</li>
<li>标签文本为空时 width = 悬浮按钮们的最大宽度。</li>
<li>height = (所有悬浮按钮的高度之和 + 所有悬浮按钮之间的间隔之和) * 12 / 10。</li>
</ul>
<p>当菜单的方向为横向时：</p>
<ul>
<li>width = (所有悬浮按钮的宽度之和 + 所有悬浮按钮之间的间隔之和) * 12 / 10。</li>
<li>height = 悬浮按钮们的最大高度。</li>
</ul>
<h2 id="onLayout_28_29"><a href="#onLayout_28_29" class="headerlink" title="onLayout()"></a>onLayout()</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="typename">void</span> onLayout(<span class="typename">boolean</span> changed, <span class="typename">int</span> l, <span class="typename">int</span> t, <span class="typename">int</span> r, <span class="typename">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (mExpandDirection) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">EXPAND_UP:</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">EXPAND_DOWN:</span></span><br><span class="line">            <span class="typename">boolean</span> expandUp = mExpandDirection == EXPAND_UP;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">                mTouchDelegateGroup.clearTouchDelegates();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//'+'号按钮Y轴位置 向上弹出则在下面 否则在上面</span></span><br><span class="line">            <span class="typename">int</span> addButtonY = expandUp ? b - t - mAddButton.getMeasuredHeight() : <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 确保按钮集中在一条直线上，计算出按钮居中点 buttonsHorizontalCenter</span></span><br><span class="line">            <span class="comment">// 如果标签文字在左边那么悬浮按钮就靠近父控件右边，标签文字在右边则反之</span></span><br><span class="line">            <span class="typename">int</span> buttonsHorizontalCenter = mLabelsPosition == LABELS_ON_LEFT_SIDE</span><br><span class="line">                    ? r - l - mMaxButtonWidth / 2</span><br><span class="line">                    : mMaxButtonWidth / <span class="number">2</span>;</span><br><span class="line">            <span class="comment">//计算'+'号按钮左边位置</span></span><br><span class="line">            <span class="typename">int</span> addButtonLeft = buttonsHorizontalCenter - mAddButton.getMeasuredWidth() / <span class="number">2</span>;</span><br><span class="line">            mAddButton.layout(addButtonLeft, addButtonY, addButtonLeft + mAddButton.getMeasuredWidth(), addButtonY + mAddButton.getMeasuredHeight());</span><br><span class="line">                </span><br><span class="line">            <span class="comment">//标签文字的偏移量</span></span><br><span class="line">            <span class="typename">int</span> labelsOffset = mMaxButtonWidth / <span class="number">2</span> + mLabelsMargin;</span><br><span class="line">            <span class="comment">//标签文字在按钮左边时 标签文字的 right 坐标，在右边时 文字的 left 坐标</span></span><br><span class="line">            <span class="typename">int</span> labelsXNearButton = mLabelsPosition == LABELS_ON_LEFT_SIDE</span><br><span class="line">                    ? buttonsHorizontalCenter - labelsOffset</span><br><span class="line">                    : buttonsHorizontalCenter + labelsOffset;</span><br><span class="line">            <span class="comment">//下一个按钮的Y轴坐标</span></span><br><span class="line">            <span class="typename">int</span> nextY = expandUp ?</span><br><span class="line">                    addButtonY - mButtonSpacing :</span><br><span class="line">                    addButtonY + mAddButton.getMeasuredHeight() + mButtonSpacing;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="typename">int</span> i = mButtonsCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line">                <span class="keyword">if</span> (child == mAddButton || child.getVisibility() == GONE) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">//按钮的left</span></span><br><span class="line">                <span class="typename">int</span> childX = buttonsHorizontalCenter - child.getMeasuredWidth() / <span class="number">2</span>;</span><br><span class="line">                <span class="comment">//按钮的top</span></span><br><span class="line">                <span class="typename">int</span> childY = expandUp ? nextY - child.getMeasuredHeight() : nextY;</span><br><span class="line">                child.layout(childX, childY, childX + child.getMeasuredWidth(), childY + child.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">                <span class="typename">float</span> collapsedTranslation = addButtonY - childY;</span><br><span class="line">                <span class="typename">float</span> expandedTranslation = <span class="number">0</span>f;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//mExpanded = false 平移到'+'按钮的位置</span></span><br><span class="line">                child.setTranslationY(mExpanded ? expandedTranslation : collapsedTranslation);</span><br><span class="line">                <span class="comment">//mExpanded = false 透明度设置为0</span></span><br><span class="line">                child.setAlpha(mExpanded ? 1f : <span class="number">0</span>f);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//设置属性动画</span></span><br><span class="line">                LayoutParams params = (LayoutParams) child.getLayoutParams();</span><br><span class="line">                <span class="comment">//设置折叠动画平移的开始和结束值</span></span><br><span class="line">                params.mCollapseDir.setFloatValues(expandedTranslation, collapsedTranslation);</span><br><span class="line">                <span class="comment">//设置展开动画平移的开始和结束值</span></span><br><span class="line">                params.mExpandDir.setFloatValues(collapsedTranslation, expandedTranslation);</span><br><span class="line">                <span class="comment">//设置动画的目标对象为child 悬浮按钮按钮，并加入到动画集合中</span></span><br><span class="line">                params.setAnimationsTarget(child);</span><br><span class="line"></span><br><span class="line">                View label = (View) child.getTag(R.id.fab_label);</span><br><span class="line">                <span class="keyword">if</span> (label != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//和labelsXNearButton相反</span></span><br><span class="line">                    <span class="comment">//标签文字在左边时,文字的 left 坐标,标签文字在右边时 文字的 right 坐标</span></span><br><span class="line">                    <span class="typename">int</span> labelXAwayFromButton = mLabelsPosition == LABELS_ON_LEFT_SIDE</span><br><span class="line">                            ? labelsXNearButton - label.getMeasuredWidth()</span><br><span class="line">                            : labelsXNearButton + label.getMeasuredWidth();</span><br><span class="line"></span><br><span class="line">                    <span class="typename">int</span> labelLeft = mLabelsPosition == LABELS_ON_LEFT_SIDE</span><br><span class="line">                            ? labelXAwayFromButton</span><br><span class="line">                            : labelsXNearButton;</span><br><span class="line">            </span><br><span class="line">                    <span class="typename">int</span> labelRight = mLabelsPosition == LABELS_ON_LEFT_SIDE</span><br><span class="line">                            ? labelsXNearButton</span><br><span class="line">                            : labelXAwayFromButton;</span><br><span class="line">                            </span><br><span class="line">                    <span class="typename">int</span> labelTop = childY - mLabelsVerticalOffset + (child.getMeasuredHeight() - label.getMeasuredHeight()) / <span class="number">2</span>;</span><br><span class="line">                    label.layout(labelLeft, labelTop, labelRight, labelTop + label.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//用于处理标签文字的触摸事件,将其范围内的触摸事件交给对应的FloatingActionButton处理</span></span><br><span class="line">                    Rect touchArea = <span class="keyword">new</span> Rect(</span><br><span class="line">                            Math.min(childX, labelLeft),</span><br><span class="line">                            childY - mButtonSpacing / <span class="number">2</span>,</span><br><span class="line">                            Math.max(childX + child.getMeasuredWidth(), labelRight),</span><br><span class="line">                            childY + child.getMeasuredHeight() + mButtonSpacing / <span class="number">2</span>);</span><br><span class="line">                    mTouchDelegateGroup.addTouchDelegate(<span class="keyword">new</span> TouchDelegate(touchArea, child));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//行为同按钮</span></span><br><span class="line">                    label.setTranslationY(mExpanded ? expandedTranslation : collapsedTranslation);</span><br><span class="line">                    label.setAlpha(mExpanded ? 1f : <span class="number">0</span>f);</span><br><span class="line">                        </span><br><span class="line">                    <span class="comment">//和上面按钮的动画设置相同</span></span><br><span class="line">                    LayoutParams labelParams = (LayoutParams) label.getLayoutParams();</span><br><span class="line">                    labelParams.mCollapseDir.setFloatValues(expandedTranslation, collapsedTranslation);</span><br><span class="line">                    labelParams.mExpandDir.setFloatValues(collapsedTranslation, expandedTranslation);</span><br><span class="line">                    labelParams.setAnimationsTarget(label);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                nextY = expandUp ?</span><br><span class="line">                        childY - mButtonSpacing :</span><br><span class="line">                        childY + child.getMeasuredHeight() + mButtonSpacing;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">EXPAND_LEFT:</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">EXPAND_RIGHT:</span></span><br><span class="line">            <span class="typename">boolean</span> expandLeft = mExpandDirection == EXPAND_LEFT;</span><br><span class="line"></span><br><span class="line">            <span class="typename">int</span> addButtonX = expandLeft ? r - l - mAddButton.getMeasuredWidth() : <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// Ensure mAddButton is centered on the line where the buttons should be</span></span><br><span class="line">            <span class="typename">int</span> addButtonTop = b - t - mMaxButtonHeight + (mMaxButtonHeight - mAddButton.getMeasuredHeight()) / <span class="number">2</span>;</span><br><span class="line">            mAddButton.layout(addButtonX, addButtonTop, addButtonX + mAddButton.getMeasuredWidth(), addButtonTop + mAddButton.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">            <span class="typename">int</span> nextX = expandLeft ?</span><br><span class="line">                    addButtonX - mButtonSpacing :</span><br><span class="line">                    addButtonX + mAddButton.getMeasuredWidth() + mButtonSpacing;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="typename">int</span> i = mButtonsCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> View child = getChildAt(i);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (child == mAddButton || child.getVisibility() == GONE) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="typename">int</span> childX = expandLeft ? nextX - child.getMeasuredWidth() : nextX;</span><br><span class="line">                <span class="typename">int</span> childY = addButtonTop + (mAddButton.getMeasuredHeight() - child.getMeasuredHeight()) / <span class="number">2</span>;</span><br><span class="line">                child.layout(childX, childY, childX + child.getMeasuredWidth(), childY + child.getMeasuredHeight());</span><br><span class="line"></span><br><span class="line">                <span class="typename">float</span> collapsedTranslation = addButtonX - childX;</span><br><span class="line">                <span class="typename">float</span> expandedTranslation = <span class="number">0</span>f;</span><br><span class="line"></span><br><span class="line">                child.setTranslationX(mExpanded ? expandedTranslation : collapsedTranslation);</span><br><span class="line">                child.setAlpha(mExpanded ? 1f : <span class="number">0</span>f);</span><br><span class="line"></span><br><span class="line">                LayoutParams params = (LayoutParams) child.getLayoutParams();</span><br><span class="line">                params.mCollapseDir.setFloatValues(expandedTranslation, collapsedTranslation);</span><br><span class="line">                params.mExpandDir.setFloatValues(collapsedTranslation, expandedTranslation);</span><br><span class="line">                params.setAnimationsTarget(child);</span><br><span class="line"></span><br><span class="line">                nextX = expandLeft ?</span><br><span class="line">                        childX - mButtonSpacing :</span><br><span class="line">                        childX + child.getMeasuredWidth() + mButtonSpacing;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>onLayout() 里同样也只对竖向的情况进行分析注释，上面的方法中大部分都是对按钮和标签文字的位置计算，我也做了详细的注释，就不多说了。</p>
<p>可以看下 50~57 行以及 90~94 行，50~57 行是对悬浮按钮设置动画效果，90~94 行是对标签文字设置动画效果，过程都是一样的，都是通过自定义的 LayoutParams 来进行设置，我们先来看下这个自定义 LayoutParams 的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Interpolator sExpandInterpolator = <span class="keyword">new</span> OvershootInterpolator();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Interpolator sCollapseInterpolator = <span class="keyword">new</span> DecelerateInterpolator(<span class="number">3f</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Interpolator sAlphaExpandInterpolator = <span class="keyword">new</span> DecelerateInterpolator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutParams</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span>.<span class="title">LayoutParams</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*菜单展开时的平移和透明渐变动画*/</span></span><br><span class="line">    <span class="keyword">private</span> ObjectAnimator mExpandDir = <span class="keyword">new</span> ObjectAnimator();</span><br><span class="line">    <span class="keyword">private</span> ObjectAnimator mExpandAlpha = <span class="keyword">new</span> ObjectAnimator();</span><br><span class="line">    <span class="comment">/*菜单折叠时的平移和透明渐变动画*/</span></span><br><span class="line">    <span class="keyword">private</span> ObjectAnimator mCollapseDir = <span class="keyword">new</span> ObjectAnimator();</span><br><span class="line">    <span class="keyword">private</span> ObjectAnimator mCollapseAlpha = <span class="keyword">new</span> ObjectAnimator();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> animationsSetToPlay;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(ViewGroup.LayoutParams source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line"></span><br><span class="line">        mExpandDir.setInterpolator(sExpandInterpolator);</span><br><span class="line">        mExpandAlpha.setInterpolator(sAlphaExpandInterpolator);</span><br><span class="line">        mCollapseDir.setInterpolator(sCollapseInterpolator);</span><br><span class="line">        mCollapseAlpha.setInterpolator(sCollapseInterpolator);</span><br><span class="line">        <span class="comment">//收起透明动画 不透明 -&gt; 透明</span></span><br><span class="line">        mCollapseAlpha.setProperty(View.ALPHA);</span><br><span class="line">        mCollapseAlpha.setFloatValues(<span class="number">1f</span>, <span class="number">0f</span>);</span><br><span class="line">        <span class="comment">//展开透明动画 透明 -&gt; 不透明</span></span><br><span class="line">        mExpandAlpha.setProperty(View.ALPHA);</span><br><span class="line">        mExpandAlpha.setFloatValues(<span class="number">0f</span>, <span class="number">1f</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (mExpandDirection) &#123;</span><br><span class="line">            <span class="keyword">case</span> EXPAND_UP:</span><br><span class="line">            <span class="keyword">case</span> EXPAND_DOWN:</span><br><span class="line">                <span class="comment">//Y轴方向上平移</span></span><br><span class="line">                mCollapseDir.setProperty(View.TRANSLATION_Y);</span><br><span class="line">                mExpandDir.setProperty(View.TRANSLATION_Y);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXPAND_LEFT:</span><br><span class="line">            <span class="keyword">case</span> EXPAND_RIGHT:</span><br><span class="line">                <span class="comment">//X轴方向上平移</span></span><br><span class="line">                mCollapseDir.setProperty(View.TRANSLATION_X);</span><br><span class="line">                mExpandDir.setProperty(View.TRANSLATION_X);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAnimationsTarget</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置动画目标视图</span></span><br><span class="line">        mCollapseAlpha.setTarget(view);</span><br><span class="line">        mCollapseDir.setTarget(view);</span><br><span class="line">        mExpandAlpha.setTarget(view);</span><br><span class="line">        mExpandDir.setTarget(view);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Now that the animations have targets, set them to be played</span></span><br><span class="line">        <span class="comment">//动画集合还没有添加成功进入语句</span></span><br><span class="line">        <span class="keyword">if</span> (!animationsSetToPlay) &#123;</span><br><span class="line">            <span class="comment">//动画监听</span></span><br><span class="line">            addLayerTypeListener(mExpandDir, view);</span><br><span class="line">            addLayerTypeListener(mCollapseDir, view);</span><br><span class="line">            <span class="comment">//将透明动画平移动画加入到动画集合中</span></span><br><span class="line">            mCollapseAnimation.play(mCollapseAlpha);</span><br><span class="line">            mCollapseAnimation.play(mCollapseDir);</span><br><span class="line">            mExpandAnimation.play(mExpandAlpha);</span><br><span class="line">            mExpandAnimation.play(mExpandDir);</span><br><span class="line">            animationsSetToPlay = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLayerTypeListener</span><span class="params">(Animator animator, <span class="keyword">final</span> View view)</span> </span>&#123;</span><br><span class="line">        animator.addListener(<span class="keyword">new</span> AnimatorListenerAdapter() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationEnd</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//view按一般方式绘制，不使用离屏缓冲．这是默认的行为．</span></span><br><span class="line">                view.setLayerType(LAYER_TYPE_NONE, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationStart</span><span class="params">(Animator animation)</span> </span>&#123;</span><br><span class="line">                <span class="comment">//如果应用被硬加速了，view会被绘制到一个硬件纹理中</span></span><br><span class="line">                <span class="comment">//如果应用没被硬加速，此类型的layer的行为同于LAYER_TYPE_SOFTWARE．</span></span><br><span class="line">                view.setLayerType(LAYER_TYPE_HARDWARE, <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LayoutParams 拥有4个属性动画，这 4 个属性动画就是我们上面分析时所需要的平移和透明渐变动画，在 setAnimationsTarget() 被调用时会被加入到动画集合中，这样我们动画集合所需要的旋转、平移、透明渐变，这几个动画效果就都具备了。</p>
<p>onLayout 所做的事情就是计算子控件的位置以及对其进行布局，另外还会对对每个悬浮按钮和对应的标签文字设置展开和折叠时的平移和透明渐变动画，然后将这些动画加入到动画合集中，达到让这些动画能同时开始的目的。</p>
<h2 id="toggle__u5C55_u5F00/_u6298_u53E0_u7684_u5F00_u5173"><a href="#toggle__u5C55_u5F00/_u6298_u53E0_u7684_u5F00_u5173" class="headerlink" title="toggle 展开/折叠的开关"></a>toggle 展开/折叠的开关</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">toggle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mExpanded) &#123;</span><br><span class="line">        collapse();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        expand();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">collapse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    collapse(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 折叠菜单</span><br><span class="line"> * <span class="doctag">@param</span> immediately 是否马上折叠（没有动画过程）</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">collapse</span><span class="params">(<span class="keyword">boolean</span> immediately)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mExpanded) &#123;</span><br><span class="line">        mExpanded = <span class="keyword">false</span>;</span><br><span class="line">        mTouchDelegateGroup.setEnabled(<span class="keyword">false</span>);</span><br><span class="line">        mCollapseAnimation.setDuration(immediately ? <span class="number">0</span> : ANIMATION_DURATION);</span><br><span class="line">        mCollapseAnimation.start();</span><br><span class="line">        mExpandAnimation.cancel();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mListener.onMenuCollapsed();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 展开菜单</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">expand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mExpanded) &#123;</span><br><span class="line">        mExpanded = <span class="keyword">true</span>;</span><br><span class="line">        mTouchDelegateGroup.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">        mCollapseAnimation.cancel();</span><br><span class="line">        mExpandAnimation.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mListener.onMenuExpanded();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>toggle() 方法是 ‘+’ 号按钮的点击监听中调用的方法，代码还是非常简单的，因为我们在之前的代码中已经将展开和折叠所需要的所有属性动画放入到了相应的动画集合中了，在这里只需要调用动画集合的 start() 这个菜单控件就能达到最开始 gif 里面的效果了。</p>
<h1 id="u6700_u540E"><a href="#u6700_u540E" class="headerlink" title="最后"></a>最后</h1><p>FloatingActionMenu 并不复杂，整个过程如下：</p>
<ol>
<li>初始化时调用 addView() 方法添加一个 ‘+’ 号按钮，这个按钮也就是菜单展开/折叠的开关，在这里会创建展开/折叠时的旋转动画，并加入到相应的动画集合中</li>
<li>重写 onFinishInflate() 方法在所有子控件 (FloatingActionButton) 添加完成后，获取子控件的 Title 后创建 TextView 加入到 FloatingActionMenu 中(Title 通过 FloatingActionButton 的 fab_title 属性设置),</li>
<li>重写 onMeasure() 方法设置控件的大小</li>
<li>重写 onLayout() 方法设置子控件的位置，并且为每一个子控件(FloatingActionButton 和 上面添加的标签文字TextView)设置展开/折叠时的平移、透明渐变动画，加入到动画集合中。</li>
<li>用户点击 ‘+’ 号按钮时触发初始化时为其设置的点击监听，toggle() 方法被调用根据当前的状态(展开还是折叠)调用相应的展开否折叠动画。</li>
</ol>
<p>以上就是 FloatingActionMenu 实现的全部过程，感谢您的阅读。</p>
</div>

            
<nav class="post-nav flex-row">
  <div class="flex-col waves-block prev">
    
      <a href="/2016/03/16/2016031610_在AndroidStudio中支持Java8/" title="在 Android Studio 中支持 Java 8" id="post-prev" class="post-nav-link">
        <i class="icon icon-chevron-left"></i>
        <span class="article-nav-title">上一篇</span>
      </a>
    
  </div>
  <div class="flex-col waves-block next">
    
      <a href="/2016/03/03/2016030311_android_floating_action_button_part1/" title="第三方控件 android floating action button 解析 (part1) - FloatingActionButton" id="post-next" class="post-nav-link">
        <span class="article-nav-title">下一篇</span>
        <i class="icon icon-chevron-right"></i>
      </a>
    
  </div>

</nav>



            




        </div>

      </div>

    

  </article>



    </div>
  </main>
<div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-circle-light"><span class="icon icon-lg icon-chevron-up"></span></a>
<div class="global-share" id="global-share" data-title="第三方控件 android floating action button 解析 (part2) - FloatingActionsMenu" data-pic="/img/logo.jpeg" data-summary="&lt;p&gt;在&lt;a href=&quot;http://luckymin.com/2016/03/03/2016030311_android_floating_action_button_part1/&quot;&gt;上一篇&lt;/a&gt;我们对 FloatingActionButton 的代码进行了分析，在这一章我们将继续解析 FloatingActionMenu 的代码，FloatingActionMenu 是基于 FloatingActionButton 的实现，其子控件必须为 FloatingActionButton 才能达到相应的效果，在开始源码解析之前先让我们先来看看 FloatingActionMenu 要怎么使用吧。&lt;/p&gt;" data-url="http://yoursite.com/2016/03/09/2016030311_android_floating_action_button_part2/index.html">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" href="javascript:;" data-title="微博" data-service="tsina">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns" href="javascript:;" data-title="微信" data-service="weixin">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" href="javascript:;" data-title=" QQ" data-service="cqq">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" href="javascript:;" data-title=" Facebook" data-service="fb">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" href="javascript:;" data-title=" Twitter" data-service="twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="douban share-sns" href="javascript:;" data-title="豆瓣" data-service="douban">
          豆
        </a>
      </li>
    </ul>
 </div>


<script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script src="/js/main.js" type="text/javascript"></script>




<script type="text/javascript">
var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cspan id='cnzz_stat_icon_1257735577' style='display:none' %3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s95.cnzz.com/z_stat.php%3Fid%3D1257735577%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
</script>






</body>
</html>
